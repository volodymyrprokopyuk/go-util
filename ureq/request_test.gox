package ureq_test

import (
	"context"
	"crypto/rsa"
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"
	"time"

	"github.com/volodymyrprokopyuk/go-util/ureq"
)

var httpc = ureq.NewClient()

func makeHMACVerify(key []byte) http.HandlerFunc {
  return func(w http.ResponseWriter, r *http.Request) {
    hmacVerify := util.AuthHMACVerify(key)
    err := hmacVerify(r)
    if err != nil {
      util.WriteError(w, err)
      return
    }
    util.WriteResponse(w, http.StatusOK, nil)
  }
}

func TestHMACSignVerifySuccess(t *testing.T) {
  ctx := context.Background()
  key := []byte("knd5r7g08umj5uapv3oxpy39hvuqsuyt")
  https := httptest.NewServer(makeHMACVerify(key))
  req := map[string]string{"request": "body"}
  res, err := httpc.POST(
    ctx, util.URL(https.URL), util.ReqJSON(req), util.HMACSign(key),
  )
  if err != nil {
    t.Fatalf("%s\n", err)
  }
  if res.StatusCode != http.StatusOK {
    t.Fatalf(
      "invalid status code: expected %d, got %d",
      http.StatusOK, res.StatusCode,
    )
  }
}

func makeJWTHS256Verify(key []byte) http.HandlerFunc {
  return func(w http.ResponseWriter, r *http.Request) {
    jwtVerify := util.AuthJWTHS256Verify(key, 10 * time.Minute)
    err := jwtVerify(r)
    if err != nil {
      util.WriteError(w, err)
      return
    }
    util.WriteResponse(w, http.StatusOK, nil)
  }
}

func TestJWTHS256SignVerifySuccess(t *testing.T) {
  ctx := context.Background()
  key := []byte("knd5r7g08umj5uapv3oxpy39hvuqsuyt")
  https := httptest.NewServer(makeJWTHS256Verify(key))
  req := map[string]string{"request": "body"}
  claims := map[string]any{
    "sub": "trainerID",
    "iat": time.Now().UTC().Add(-1 * time.Minute).Unix(),
    "exp": time.Now().UTC().Add(1 * time.Minute).Unix(),
  }
  res, err := httpc.POST(
    ctx, util.URL(https.URL), util.ReqJSON(req), util.JWTHS256Sign(key, claims),
  )
  if err != nil {
    t.Fatalf("%s\n", err)
  }
  if res.StatusCode != http.StatusOK {
    t.Fatalf(
      "invalid status code: expected %d, got %d",
      http.StatusOK, res.StatusCode,
    )
  }
}

// openssl genrsa -out prv.pem 2048
// openssl rsa -in prv.pem -pubout -out pub.pem

var prvJWTRS256 = strings.ReplaceAll(`-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCHyZWqv8oa1pne
EzpI/0Ru7AyHwQsGLKk2RiIDzXsio5fHSSDHk/S6xfDzrxtYqR8yfzeoUdvX5rAP
cWfaoCis+oaVh+ezWXam1r1+7jBAk8Tjq9t7nGnf298jE98M9EHN1pP5F4x8mcex
tWemGeoXiCH9JSpoaoaHCli3ORJsWezcbRfHfR/amCZgdLl9cvRSJVanZjpZ1xTl
yjXouwbWCyrSObv5a7hDZlWW86xg5lwd8Y57xUznm8gyMp4gEMryQUkjg2OQ7sVX
Osr45c6WkClMphVqSden69cmwUNq86v3KOc2SEbRoEDzx75ohyUgAcggc+wP+aFc
X5QHspe/AgMBAAECggEAAJ7bt72Lo2bCqkClPgsomWcrwX0Q21Td6xkT87d/Lg/Y
VDlR1IepESdxa/OraNLRCS6KpxLEse5kdJWcl2Ou++djMRC/btLkV2vYztkw0EK8
nhu9c4mp9DNxiBwBo3IEUPf/kh5Y7oLXZkkBccFhj/z3xsviLzr5ZWmXMTMqEeOv
nIu8TT8uXq8aIBBBXf4rNkqblUhzMhlpzouqwWD3uQr6piAAPEWZ+aoUIVL3UzZe
Ouj4OhnwEYXhx8+vNv7qC2CEN+XTO//4GVZe87wBPWEDLpXU31N45QX+1NZbBqeR
4wTlOq4ICrRfkaTnTh/i6fZ3j84O+8HWHyU1p701mQKBgQC++kj9CDPn0PCCSaaY
p5xVuZ1xyb5VWvZuhJ3BT0kL7ZoeOmjTEIGzIic0lJYLQ+L3/mFud+RrC6bJGni8
DqCOTmoj+x+XEMiio9NNfpOztkeFgxTcHHcpGOzCuNxv09mRa2FlEpxltq4kxOqo
ozYHbgVIcgGHksFrRlXdVhp5+QKBgQC2BOOzVipZD6mDd36x7ph5cqXq8Ul2Qyo9
R42j/9NV7kCXZvd+QmAxWZ1T81M+qeIazcNLHqma8qaG1YMoARZz80fkRPywBAj9
Qb9IZI+rbfU/snoufBzbb+RHbilS8MUFGdr0nNMCPTVm9Z5Nu8AzntskatFzmtzb
EeiMbVRNdwKBgQCVGBi7UhgTto7NaGpjaxcl5c8A8pthT65sAaSXMiq44Toct0T2
4kAfdV5eMlIhYVJkgXfXIkp1N5dyEPSI/HJkJtu+U2MKMNQyBOwF5/evqXKUzQ0P
+jkdIJRWQLP3qdCFMuvKWIk47zFtCz6XgTPBASemszp2eR//e920+m+ZIQKBgESH
9L9Z6tnbdsRj4lTV85yOWP/rVvBq+2VVInQj5wsMiE842mg0T4llJ0IrdCU8yz+y
RxxqcAtB3wcXLqmKN0zyxReiDc2rx0KrVXzJN/qgjN0tsqj729WW/EkUpgRvWI7C
HFlLDntiVk/snGzCCuykm/fLLA8tuIfW50qwAzSjAoGBAI8+zafK9TSFQKd9miyk
QItqS7L9w/8XaHhKJxo8SNFE8zCGLFy0/BnSFPsz9i9QB/ogwzFEj+IX0+dsrcvm
LQKvQBWXXUiTgKDOdMWuJjbHdZjDZB4JS5f20DY6Qa+mfWhSzoB0L+9L6m+vaPCt
VcalLtNYO+mZIlNaQuNsP/mF
-----END PRIVATE KEY-----`, "\n", `\n`)

var pubJWTRS256 = strings.ReplaceAll(`-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAh8mVqr/KGtaZ3hM6SP9E
buwMh8ELBiypNkYiA817IqOXx0kgx5P0usXw868bWKkfMn83qFHb1+awD3Fn2qAo
rPqGlYfns1l2pta9fu4wQJPE46vbe5xp39vfIxPfDPRBzdaT+ReMfJnHsbVnphnq
F4gh/SUqaGqGhwpYtzkSbFns3G0Xx30f2pgmYHS5fXL0UiVWp2Y6WdcU5co16LsG
1gsq0jm7+Wu4Q2ZVlvOsYOZcHfGOe8VM55vIMjKeIBDK8kFJI4NjkO7FVzrK+OXO
lpApTKYVaknXp+vXJsFDavOr9yjnNkhG0aBA88e+aIclIAHIIHPsD/mhXF+UB7KX
vwIDAQAB
-----END PUBLIC KEY-----`, "\n", `\n`)

func makeJWTRS256Verify(pub *rsa.PublicKey) http.HandlerFunc {
  return func(w http.ResponseWriter, r *http.Request) {
    jwtVerify := util.AuthJWTRS256Verify(pub, 10 * time.Minute)
    err := jwtVerify(r)
    if err != nil {
      util.WriteError(w, err)
      return
    }
    util.WriteResponse(w, http.StatusOK, nil)
  }
}

func TestJWTRS256SignVerifySuccess(t *testing.T) {
  ctx := context.Background()
  prv, err := util.ReadPrvRSA(prvJWTRS256)
  if err != nil {
    t.Fatalf("%s\n", err)
  }
  pub, err := util.ReadPubRSA(pubJWTRS256)
  if err != nil {
    t.Fatalf("%s\n", err)
  }
  https := httptest.NewServer(makeJWTRS256Verify(pub))
  req := map[string]string{"request": "body"}
  claims := map[string]any{
    "sub": "trainerID",
    "iat": time.Now().UTC().Add(-1 * time.Minute).Unix(),
    "exp": time.Now().UTC().Add(1 * time.Minute).Unix(),
  }
  res, err := httpc.POST(
    ctx, util.URL(https.URL), util.ReqJSON(req), util.JWTRS256Sign(prv, claims),
  )
  if err != nil {
    t.Fatalf("%s\n", err)
  }
  if res.StatusCode != http.StatusOK {
    t.Fatalf(
      "invalid status code: expected %d, got %d",
      http.StatusOK, res.StatusCode,
    )
  }
}
